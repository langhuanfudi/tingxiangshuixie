<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>cpp - My Docs</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">index</a>
                            </li>
                            <li class="navitem">
                                <a href="../about/" class="nav-link">about</a>
                            </li>
                            <li class="navitem active">
                                <a href="./" class="nav-link">cpp</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../about/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" class="nav-link disabled">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="2"><a href="#_1" class="nav-link">为何需要移动语义</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#_2" class="nav-link">一个移动示例</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h2 id="_1">为何需要移动语义</h2>
<p>假设我们要做这样一个复制过程</p>
<pre><code class="language-c++">vector&lt;string&gt; vstr;
// 构建一个包含20000个string的vector, 每个string有1000个字符
vector&lt;string&gt; vstr_copy1(vstr); //vstr_copy1是vstr的复制
</code></pre>
<p>在vector类和string类中都会定义一个拷贝构造函数，其中使用了某个版本的new函数。为了初始化vstr_copy1，vector<string>的拷贝构造函数会用new来给这20000个string对象分配内存。而每个string对象又会用string中的拷贝构造函数来为1000个字符分配内存。总共会将20000000个字符从vstr控制的内存中拷贝到vstr_copy1控制的内存中。但是这有时候是不妥当的，比如：</p>
<pre><code class="language-c++">vector&lt;string&gt; allcaps(const vector&lt;string&gt; &amp;vs){
    vector&lt;string&gt; temp;
    //把vs中所有字符的大写存入temp
    return temp;
}

vector&lt;string&gt; vstr;
// 构建一个包含20000个string的vector, 每个string有1000个字符
vector&lt;string&gt; vstr_copy1(vstr);          //#1
vector&lt;string&gt; vstr_copy2(allcaps(vstr));   //#2
</code></pre>
<p>对语句#2来说，allcaps(vstr)创建了对象temp，管理了20000000个字符。vector类和string类的拷贝构造函数需要copy这200000000个字符，然后删除allcaps()返回的临时对象，做了大量的无用功。比较好的方法是，不需要copy这20000000个字符，而是直接将其所有权转让给vstr_copy2。这类似于在计算机中移动文件，文件实际的位置没变化，只是修改了记录。这被称为移动语义(move semantics)。</p>
<blockquote>
<p>好比你家住在上海，现在你家位置完全没变，但把上海直接改名叫北京，然后你家就住在北京了</p>
</blockquote>
<p>要实现移动语义需要通过某种方式让编译器知道，什么时候要copy，什么时候不要。右值引用就是干这个的，对于常规的拷贝构造函数，用const左值引用来作为参数，将这个引用关联到左值实参，如语句#1中的vstr。另外写一个移动构造函数，用右值引用作为参数，关联到右值实参，如语句#2中的allcaps(vstr)。拷贝构造函数可以执行深复制，移动构造函数只修改记录。移动构造函数要把所有权转移给新对象，可能修改其实参，意味着右值引用的参数不是const的。</p>
<h2 id="_2">一个移动示例</h2>
<pre><code class="language-c++">class Useless {
private:
    int n;         // number of elements
    char *pc;      // pointer to data
    static int ct; // number of objects
    void ShowObject() const;

public:
    Useless();
    explicit Useless(int k);
    Useless(int k, char ch);
    Useless(const Useless &amp;f); // regular copy constructor
    Useless(Useless &amp;&amp;f);      // move constructor
    ~Useless();
    Useless operator+(const Useless &amp;f) const;
    void ShowData() const;
};

Useless::Useless(const Useless &amp;f) : n(f.n) {
    ++ct;
    cout &lt;&lt; &quot;copy const called; number of objects: &quot; &lt;&lt; ct &lt;&lt; endl;
    pc = new char[n];
    for (int i = 0; i &lt; n; i++) pc[i] = f.pc[i];
    ShowObject();
}

Useless::Useless(Useless &amp;&amp;f) {
    ++ct;
    cout &lt;&lt; &quot;move constructor called; number of objects: &quot; &lt;&lt; ct &lt;&lt; endl;
    pc = f.pc; //steal address
    f.pc = nullptr;
    f.n = 0;
    ShowObject();
}
</code></pre>
<p>这里只列举了普通的拷贝构造函数和移动构造函数。拷贝构造函数执行了深复制，而移动构造函数直接将pc指向现有的数据来获取所有权。pc和f.pc不能指向同一个地址，因为析构时不能delete两次，所以要将原来的f.pc设为nullptr。这里修改了f，所以参数声明中不加const。</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
